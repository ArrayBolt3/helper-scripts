#!/bin/bash

## Copyright (C) 2014 - 2020 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

exit_handler() {
   echo "$0: INFO: Exiting with exit code $exit_code."
   exit "$exit_code"
}

exit_code=1

trap exit_handler EXIT

set_date() {
   echo "$0: INFO: Running: 'date --utc \"+%Y-%m-%d %H:%M:%S\" --set "$time_result"'"
   date --utc "+%Y-%m-%d %H:%M:%S" --set "$time_result"
   exit_code="$?"
}

if [ "$(whoami)" = "sdwdate" ]; then
   anondate_state_folder=/run/sdwdate
elif [ "$(id -u)" = "0" ]; then
   anondate_state_folder=/run/anondate
   mkdir -p "$anondate_state_folder"
else
   echo "$0: ERROR: Must run as root." >&2
   exit 112
fi
anondate_tor_certificate_lifetime_set_file="${anondate_state_folder}/tor_certificate_lifetime_set"

if test -f "$anondate_tor_certificate_lifetime_set_file" ; then
   echo "$0: INFO: Status file '$anondate_tor_certificate_lifetime_set_file' exists."
else
   echo "$0: INFO: Status file '$anondate_tor_certificate_lifetime_set_file' does not yet exist."
fi

echo "$0: INFO: running anondate-get..."

anondate_get_exit_code=0
time_result="$(anondate-get)" || { anondate_get_exit_code="$?" ; true; };

if [ "$anondate_get_exit_code" = "0" ]; then
   echo "$0: INFO: anondate-get returned Tor consensus middle range time."
   set_date
elif [ "$anondate_get_exit_code" = "1" ]; then
   echo "$0: INFO: Setting time using anondate either not possible or not required."
   exit_code=2
elif [ "$anondate_get_exit_code" = "2" ]; then
   if test -f "$anondate_tor_certificate_lifetime_set_file" ; then
      echo "$0: INFO: No, not again setting system clock to Tor certificate lifetime."
   else
      echo "$0: INFO: Yes, setting system clock to Tor certificate lifetime."
      set_date
      echo "$0: INFO: Creating status file '$anondate_tor_certificate_lifetime_set_file'."
      touch "$anondate_tor_certificate_lifetime_set_file"
      echo "$0: INFO: Done, created status file '$anondate_tor_certificate_lifetime_set_file'."
      ## If clock was too fast, restart of Tor is required.
      echo "$0: INFO: Tor restart using 'systemctl restart tor@default'..."
      ## TODO: vs sdwdate systemd hardening
      systemctl --no-pager restart tor@default
      echo "$0: INFO: Tor restart done."
      exit_code=2
   fi
fi
