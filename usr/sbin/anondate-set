#!/bin/bash

## Copyright (C) 2014 - 2020 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

exit_handler() {
   echo "$0: INFO: Exiting with exit code $exit_code."
   exit "$exit_code"
}

exit_code=1

trap exit_handler EXIT

if [ "$(whoami)" = "sdwdate" ]; then
   true
elif [ "$(id -u)" != "0" ]; then
   echo "$0: ERROR: Must run as root." >&2
   exit 112
fi

echo "$0: INFO: running anondate-get..."

anondate_get_exit_code=0
time_result="$(anondate-get)" || { anondate_get_exit_code="$?" ; true; };

if [ ! "$anondate_get_exit_code" = "0" ]; then
   echo "$0: INFO: Setting time using anondate either not possible or not required."
   exit_code=2
else
   echo "$0: INFO: Running: 'date --utc --set "$time_result"'"
   date --utc --set "$time_result"
   exit_code="$?"
fi
