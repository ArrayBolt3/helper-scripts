#!/bin/bash

## Copyright (C) 2018 - 2022 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

whonix() {
   if test -f /usr/share/anon-gw-base-files/gateway ; then
      return 0
   else
      return 1
   fi
}

if whonix ; then
    torrc_file_path='/usr/local/etc/torrc.d/40_tor_control_panel.conf'
    torrc_user_file_path='/usr/local/etc/torrc.d/50_user.conf'
else
    torrc_file_path='/etc/torrc.d/40_tor_control_panel.conf'
    torrc_user_file_path='/etc/torrc.d/50_user.conf'
fi

torrc_text='# Do not edit this file!
# Please add modifications to the following file instead:
'

user_text='# Tor user specific configuration file
#
# Add user modifications below this line:
############################################
'

mkdir --parents /etc/torrc.d

if whonix ; then
   mkdir --parents /usr/local/etc/torrc.d

   if grep -q "%include /etc/torrc.d/\$" "/etc/tor/torrc" ; then
      true "INFO: still using old include directive - %include /etc/torrc.d/ - upgrading..."
       search="%include /etc/torrc.d/"
      replace="%include /etc/torrc.d/*.conf"
      file_name="/etc/tor/torrc"
      str_replace "$search" "$replace" "$file_name"
   fi
fi

## Guarantee the existence of:
## 1. /etc/torrc.d/95_whonix.conf
## 2. /etc/tor/torrc
## 3. "%include /etc/torrc.d/*.conf" line in /etc/tor/torrc file

## In addition, we create 40_tor_control_panel.conf
## and 50_user.conf here if they do not exist.

whonix_torrcd_path='/etc/torrc.d/95_whonix.conf'

if test -f /etc/tor/torrc ; then
   true "INFO: file /etc/tor/torrc already exists, ok."
   if grep -q '%include /etc/torrc.d/\*.conf$' /etc/tor/torrc ; then
      true "INFO: already includes - %include /etc/torrc.d/*.conf - ok."
   else
      true "INFO: does not include - %include /etc/torrc.d/*.conf - yet."
      if whonix ; then
         echo '%include /etc/torrc.d/*.conf' | tee -a /etc/tor/torrc >/dev/null
      else
         echo "%include $torrc_file_path" | tee -a /etc/tor/torrc >/dev/null
         echo "%include $torrc_user_file_path" | tee -a /etc/tor/torrc >/dev/null
      fi
   fi
else
   true "INFO: file /etc/tor/torrc does not exist yet, creating..."
   if whonix ; then
      echo "%include /etc/torrc.d/*.conf" | tee -a /etc/tor/torrc >/dev/null
   else
      echo "%include $torrc_file_path" | tee -a /etc/tor/torrc >/dev/null
      echo "%include $torrc_user_file_path" | tee -a /etc/tor/torrc >/dev/null
   fi
fi

if whonix ; then
   if test -f "$whonix_torrcd_path" ; then
      true "INFO: file $whonix_torrcd_path already exists, ok."
   else
      true "INFO: file $whonix_torrcd_path does not exist yet, creating."
      echo "%include $torrc_file_path" | tee -a "$whonix_torrcd_path" >/dev/null
      echo "%include $torrc_user_file_path" | tee -a "$whonix_torrcd_path" >/dev/null
   fi
fi

if whonix ; then
   torrc_text="$torrc_text"
else
   torrc_text="$torrc_text
Log notice file /run/tor/log"
fi

if test -f "$torrc_file_path" ; then
   true "INFO: file $torrc_file_path already exists, ok."
else
   true "INFO: file $torrc_file_path does not exist yet, creating..."
   echo "$torrc_text" | tee "$torrc_file_path" >/dev/null
fi

if test -f "$torrc_user_file_path" ; then
   true "INFO: file $torrc_user_file_path already exits, ok."
else
   true "INFO: file $torrc_user_file_path does not exist yet, creating..."
   echo "$user_text" | tee "$torrc_user_file_path" >/dev/null
fi
